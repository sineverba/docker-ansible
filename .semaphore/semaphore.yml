version: v1.0

name: Test
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:

  env_vars:
    - name: DOCKER_USERNAME
      value: sineverba
    - name: DOCKER_IMAGE
      value: ansible
    - name: PYTHON_VERSION
      value: 3.12.3
    - name: ANSIBLE_GALAXY_VERSION
      value: 8.6.0
    - name: OPEN_SSH_VERSION
      value: "9.6"

blocks:
  - name: 'Build and test'
    skip:
      when: "tag =~ '.*'"
    task:
      jobs:
        - name: 'Build and test'
          commands:
            - checkout
            - >-
              docker build 
              --build-arg PYTHON_VERSION=$PYTHON_VERSION 
              --build-arg OPEN_SSH_VERSION=$OPEN_SSH_VERSION
              --build-arg ANSIBLE_GALAXY_VERSION=$ANSIBLE_GALAXY_VERSION
              --tag $DOCKER_USERNAME/$DOCKER_IMAGE 
              --file dockerfiles/production/Dockerfile 
              "."
            - >-
              docker run 
              --rm 
              -it 
              --entrypoint cat 
              --name $DOCKER_IMAGE 
              $DOCKER_USERNAME/$DOCKER_IMAGE 
              /etc/os-release | grep "Debian GNU/Linux 12 (bookworm)"
            - >-
              docker run 
              --rm 
              -it 
              --entrypoint python 
              --name $DOCKER_IMAGE 
              $DOCKER_USERNAME/$DOCKER_IMAGE 
              --version | grep $PYTHON_VERSION
            - >-
              docker run 
              --rm 
              -it 
              --name $DOCKER_IMAGE 
              $DOCKER_USERNAME/$DOCKER_IMAGE | grep "core 2.16.6"
            - >-
              docker run 
              --rm 
              -it 
              --entrypoint ssh 
              --name $DOCKER_IMAGE 
              $DOCKER_USERNAME/$DOCKER_IMAGE -V | grep $OPEN_SSH_VERSION
            - >-
              docker run 
              --rm 
              -it 
              --entrypoint ansible-galaxy 
              --name $DOCKER_IMAGE 
              $DOCKER_USERNAME/$DOCKER_IMAGE collection list community.general | grep $ANSIBLE_GALAXY_VERSION