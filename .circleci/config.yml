version: 2.1
executors:
  amd64_executor:
    machine:
      image: ubuntu-2404:2025.09.1
    resource_class: medium
    environment:
      DOCKER_IMAGE: ansible
      PYTHON_VERSION: 3.14.2

jobs:
  build_amd64:
    executor: amd64_executor
    steps:
      - checkout
      - run:
          name: "Login to Docker HUB"
          command: docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD
      - run:
          name: "Build image and push to Docker HUB"
          command: |
            docker build \
            --build-arg PYTHON_VERSION=$PYTHON_VERSION \
            --tag $DOCKER_LOGIN/$DOCKER_IMAGE:$CIRCLE_TAG \
            --tag $DOCKER_LOGIN/$DOCKER_IMAGE:latest \
            --file dockerfiles/Dockerfile \
            . && \
            docker push $DOCKER_LOGIN/$DOCKER_IMAGE:$CIRCLE_TAG && \
            docker push $DOCKER_LOGIN/$DOCKER_IMAGE:latest

workflows:
  test_and_build_images:
    jobs:
      - build_amd64:
          context: SECRETS
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/